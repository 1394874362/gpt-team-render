<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Team é‚€è¯·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
    <div class="min-h-screen flex items-center justify-center px-6 py-12">
        <div class="w-full max-w-md">
            <!-- Logo/æ ‡é¢˜åŒºåŸŸ -->
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <h1
                    class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    ChatGPT Team é‚€è¯·
                </h1>
                <p id="linkInfo" class="text-gray-500 mt-2">æ­£åœ¨åŠ è½½é“¾æ¥ä¿¡æ¯...</p>
            </div>

            <!-- é‚€è¯·è¡¨å• -->
            <div id="formContainer" class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <form id="inviteForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±åœ°å€ *</label>
                        <input type="email" id="email" required placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div id="promoterSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¨å¹¿ç  (å¯é€‰)</label>
                        <input type="text" id="referralCode" placeholder="å¡«å†™æ¨å¹¿ç æ”¯æŒæ‚¨å–œæ¬¢çš„æ¨å¹¿å‘˜"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <button type="submit" id="submitBtn"
                        class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-all transform hover:scale-[1.02] shadow-lg">
                        è·å–é‚€è¯·
                    </button>
                </form>

                <!-- çŠ¶æ€æç¤º -->
                <div id="statusMessage" class="hidden mt-4 p-4 rounded-xl text-center"></div>
            </div>

            <!-- é”™è¯¯é¡µé¢ -->
            <div id="errorContainer"
                class="hidden bg-white rounded-2xl shadow-xl p-8 border border-gray-100 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">é“¾æ¥æ— æ•ˆ</h2>
                <p id="errorMessage" class="text-gray-500">æ­¤é‚€è¯·é“¾æ¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ</p>
            </div>

            <!-- æˆåŠŸé¡µé¢ -->
            <div id="successContainer"
                class="hidden bg-white rounded-2xl shadow-xl p-8 border border-gray-100 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">é‚€è¯·å‘é€æˆåŠŸï¼</h2>
                <p class="text-gray-500">è¯·æŸ¥æ”¶æ‚¨çš„é‚®ç®±ï¼Œç‚¹å‡»é‚€è¯·é“¾æ¥åŠ å…¥ Team</p>
            </div>

            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <p class="text-center text-gray-400 text-sm mt-6">
                GPT Team Invite System - Powered by Render
            </p>
        </div>
    </div>

    <script>
        // âœ… æ–°é…ç½®ï¼šæŒ‡å‘RenderæœåŠ¡ï¼ˆå®Œå…¨è„±ç¦»Cloudflareï¼‰
        const API_BASE = window.location.origin; // ä½¿ç”¨å½“å‰åŸŸåï¼ˆRenderï¼‰

        // ä»URLè·å–é“¾æ¥ä»£ç 
        const pathParts = window.location.pathname.split('/');
        let linkCode = pathParts[pathParts.length - 1];
        // å¦‚æœè·¯å¾„æœ«å°¾æ˜¯'link'æˆ–ç©ºï¼Œåˆ™ä»queryå‚æ•°è·å–
        if (!linkCode || linkCode === 'link' || linkCode === 'link.html') {
            linkCode = new URLSearchParams(window.location.search).get('code');
        }

        let linkData = null;

        // é¡µé¢åŠ è½½æ—¶è·å–é“¾æ¥ä¿¡æ¯
        async function init() {
            if (!linkCode) {
                showError('ç¼ºå°‘é“¾æ¥ä»£ç ');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/link-info?code=${linkCode}`);
                const data = await res.json();

                if (data.code === 200 && data.data) {
                    linkData = data.data;
                    document.getElementById('linkInfo').textContent =
                        `${linkData.name} Â· ${getValidityText(linkData.validityType)} Â· å‰©ä½™ ${linkData.remainingUses || (linkData.maxUses - linkData.usedCount)} æ¬¡`;
                    document.getElementById('formContainer').classList.remove('hidden');
                } else {
                    showError(data.message || 'é“¾æ¥ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ');
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('linkInfo').textContent = '';
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess() {
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('successContainer').classList.remove('hidden');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, isError = false) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = `mt-4 p-4 rounded-xl text-center ${isError ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`;
            el.classList.remove('hidden');
        }

        // è¡¨å•æäº¤
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const referralCode = document.getElementById('referralCode').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (!email) {
                showStatus('è¯·è¾“å…¥é‚®ç®±åœ°å€', true);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'å‘é€ä¸­...';
            showStatus('æ­£åœ¨å‘é€é‚€è¯·ï¼Œè¯·ç¨å€™...');

            try {
                // æ­¥éª¤1: éªŒè¯é“¾æ¥å¹¶è·å–sessionIdï¼ˆä¸å†æš´éœ²tokenï¼‰
                const redeemRes = await fetch(`${API_BASE}/api/redeem-link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ linkCode, email, referralCode })
                });
                const redeemData = await redeemRes.json();

                if (redeemData.code !== 200) {
                    throw new Error(redeemData.message || 'é“¾æ¥å…‘æ¢å¤±è´¥');
                }

                const { sessionId } = redeemData.data;

                // æ­¥éª¤2: ä½¿ç”¨sessionIdè°ƒç”¨å®‰å…¨é‚€è¯·API ğŸ”
                showStatus('æ­£åœ¨å‘é€é‚€è¯·é‚®ä»¶...');
                const inviteRes = await fetch(`${API_BASE}/api/send-invite-secure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        email
                    })
                });
                const inviteResult = await inviteRes.json();

                // æ­¥éª¤3: å¤„ç†ç»“æœ
                if (inviteResult.code === 200 && inviteResult.data?.inviteSuccess) {
                    showSuccess();
                } else {
                    const errorMsg = inviteResult.data?.error || inviteResult.message || 'é‚€è¯·å‘é€å¤±è´¥';
                    showStatus(errorMsg, true);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'é‡æ–°å‘é€';
                }

            } catch (error) {
                showStatus(error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', true);
                submitBtn.disabled = false;
                submitBtn.textContent = 'é‡æ–°å‘é€';
            }
        });

        function getValidityText(t) {
            return { once: 'ä¸€æ¬¡æ€§', month: 'æœˆå¡', quarter: 'å­£å¡', year: 'å¹´å¡', permanent: 'æ°¸ä¹…' }[t] || t;
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>

</html>